<template>
  <v-row no-gutters>
    <v-col xs="0" lg="9">
      <div class="fullheight">
        <qmap v-if="!this.loading" :geojsonitems="items" />
      </div>
    </v-col>
    <v-col xs="12" lg="3">
      <v-data-table
        :headers="$store.state.app.tableheaders.narrow"
        :items="items"
        :options.sync="options"
        :server-items-length="totalItems"
        :loading="loading"
        :calculate-widths="true"
        :hide-default-footer="true"
      >
        <template v-slot:top="{ pagination, options, updateOptions }">
          <v-data-footer
            :pagination="pagination"
            :options="options"
            :items-per-page-options="itemsPerPageOptions"
            show-first-last-page
            @update:options="updateOptions"
          />
        </template>
        <template v-slot:item.features[0].systemClass="{ item }">
          <v-tooltip right>
            <template v-slot:activator="{ on, attrs }">
              <v-icon
                color="primary"
                dark
                v-bind="attrs"
                v-on="on"
              >
                {{ getIconBySystemClass(item.features[0].systemClass) }}
              </v-icon>
            </template>
            <span>
              {{ getCRMClassBySystemClass(item.features[0].systemClass) }}
              -
              {{ getLabelBySystemClass({ c: item.features[0].systemClass, l: 'en' }) }}
            </span>
          </v-tooltip>
        </template>
        <template v-slot:item.features[0].properties.title="{ item }">
          <nuxt-link :to="`/single/${item.features[0]['@id'].split('/').splice(-1)[0]}`">
            {{ item.features[0].properties.title }}
          </nuxt-link>
        </template>
      </v-data-table>
    </v-col>
  </v-row>
</template>

<script>
import { mapGetters } from 'vuex';
import qmap from '~/components/map.vue';

export default {
  components: {
    qmap,
  },
  props: {
    filter: {
      type: Object,
      default: () => {},
    },
  },
  async fetch() {
    this.loading = true;
    const { sortBy, sortDesc, page, itemsPerPage } = this.options;
    // eslint-disable-next-line no-underscore-dangle
    const p = await this.$api.Entities.get_api_0_2_query_({
      limit: itemsPerPage,
      first: this.itemIndex[page - 1] ? this.itemIndex[page - 1].startId : null,
      filter: this.filter,
      column: sortBy ? this.getSortColumnByPath(sortBy[0]) : null,
      sort: sortDesc[0] ? "desc" : "asc",
    });
    // eslint-disable-next-line prefer-destructuring
    console.log(p.body);
    this.items = p.body.results;
    this.itemIndex = p.body.pagination.index;
    this.totalItems = p.body.pagination.entities;
    this.loading = false;
  },
  data() {
    return {
      items: [],
      loading: true,
      options: {
        sortBy: [],
        sortDesc: [],
        page: 1,
        itemsPerPage: 50,
      },
      itemsPerPageOptions: [10, 20, 50],
      totalItems: 0,
      itemIndex: [],
    };
  },
  watch: {
    options: {
      handler(o, n) {
        if ((o.sortBy !== n.sortBy) || (o.sortDesc !== n.sortDesc)) this.itemIndex = [];
        this.$fetch();
      },
      deep: true,
    },
    filter: {
      handler() {
        this.itemIndex = [];
        this.totalItems= 0;
        this.options.page = 1;
        this.$fetch(); },
      deep: true,
    },
  },
  computed: {
    ...mapGetters('app', [
      'getIconBySystemClass',
      'getLabelBySystemClass',
      'getCRMClassBySystemClass',
      'getSortColumnByPath',
       'getSystemClassForFilter',
      'getFilterList',
    ]),
  },
};
</script>
<style>
.fullheight {
  height: calc(100vh - 64px);
}
</style>
